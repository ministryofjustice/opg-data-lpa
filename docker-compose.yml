services:
  mock-sirius:
    build:
      context: ./mock_sirius_backend
      dockerfile: Dockerfile
    volumes:
      - ./mock_sirius_backend/:/var/www/mock_sirius_backend/
    ports:
      - "5001:5001"

  localstack:
    image: localstack/localstack:4.6
    volumes:
      - "./localstack/init:/etc/localstack/init/ready.d"
    environment:
      AWS_DEFAULT_REGION: eu-west-1
    restart: unless-stopped

  redis:
    image: "redis:alpine@sha256:987c376c727652f99625c7d205a1cba3cb2c53b92b0b62aade2bd48ee1593232"
    ports:
      - "0.0.0.0:6379:6379"

  api_gateway:
    build:
      context: ./lambda_functions/v1
    depends_on:
      - localstack
      - mock-sirius
      - redis
    volumes:
      - ./lambda_functions/v1/:/var/www/lambda_functions/v1/
    environment:
      ENVIRONMENT: local
      AWS_ACCESS_KEY_ID: testing
      AWS_SECRET_ACCESS_KEY: testing
      AWS_SECURITY_TOKEN: testing
      AWS_SESSION_TOKEN: testing
      AWS_DEFAULT_REGION: eu-west-1
      SIRIUS_BASE_URL: http://mock-sirius:5001
      SIRIUS_API_VERSION: v1
      SESSION_DATA: publicapi@opgtest.com
      LOCALSTACK_HOST: localstack
      REQUEST_CACHING: enabled
      REQUEST_CACHING_TTL: 48
      REQUEST_CACHING_NAME: opg-data-lpa
      REDIS_URL: redis://redis:6379
    networks:
      default:
        aliases:
          - lpa.local

  unit-test-lpa-data:
    image: unit-tests-request-handler:latest
    build:
      context: lambda_functions/v1
      dockerfile: Dockerfile-tests
    volumes:
      - "./pact:/tmp/pact"
      - /var/run/docker.sock:/var/run/docker.sock
